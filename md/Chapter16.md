# [Chapter 16](https://livebook.manning.com/book/modern-java-in-action/chapter-16/)

# CompletableFuture : 안정적 비동기 프로그래밍

# 이 장의 내용

- 비동기 작업을 만들고 결과 얻기
- 비블록 동작으로 생산성 높이기
- 비동기 API 설계와 구현
- 동기 API를 비동기적으로 소비하기
- 두 개 이상의 비동기 연산을 파이프라인으로 만들고 합치기
- 비동기 작업 완료에 대응하기

16장에서는 실용적인 예제를 통해 자바 8에서 제공하는 Future의 구현 CompletableFuture이 비동기 프로그램에 얼마나 큰 도움을 주는지 설명한다. 또한 자바9에서
추가된 내용도 소개할 것이다.

## 16.1 Future의 단순 활용

Future 인터페이스(자바 5)

- 미래의 어느 시점에 결과를 얻는 모델에 활용
- 비동기 계산을 모델링
- 계산이 끝났을 때 결과에 접근할 수 있는 참조를 제공
- 시간이 걸릴 수 있는 작업을 Future 내부로 설정하면 호출자 스레드가 결과를 기다리는 동안 다른 유용한 작업을 수행할 수 있다.
- 저수준의 스레드에 비해 직관적으로 이해하기 쉽다

> 세탁소에 한 무더기의 옷을 드라이클리닝 서비스를 맡기는 동작에 비유
>
> 세탁소 주인은 드라이클리닝이 언제 끝날지 적힌 영수증(Future)을줄 것이다. 드라이클리닝이 진행되는 동안 우리는 원하는 일을 할 수 있다

Future를 이용하려면 시간이 오래 걸리는 작업을 Callable 객체 내부로 감싼 다음에 ExecutorService에 제출해야 한다.

- [그림 16-1] Future로 시간이 오래 걸리는 작업을 비동기적으로 실행하기
    - ![](https://drek4537l1klr.cloudfront.net/urma2/Figures/16fig01_alt.jpg)
    - idle(유휴)
- 오래 걸리는 작업이 영원히 끝나지 않는 문제가 있을수 있음
    - get 메서드를 오버로드해서 우리 스레드가 대기할 최대 타임아웃 시간을 설정하는 것이 좋다.

### 16.1.1 Future 제한

- Future 인터페이스가 비동기 계산이 끝났는지 확인할 `isDone` 메서드
- 계산이 끝나길 기다리는 메서드
- 결과 회수 메서드

하지만 이들 메서드만으로는 간결한 동시 실행 코드를 구현하기에 충분하지 않다.

- 여러 Future의 결과가 있을 때 이들의 의존성은 표현하기가 어렵다
- > 오래 걸리는 A라는 계산이 끝나면 그 결과를 다른 오래 걸리는 계산 B로 전달하시오.
  > 그리고 B의 결과가 나오면 다른 질의의 결과와 B의 결과를 조합하시오

선언형 기능이 있다면 유용할 것

- 두 개의 비동기 계산 결과를 하나로 합친다. 두 가지 계산 결과는 서로 독립적일 수 있으며 또는 두 번째 결과가 첫 번째 결과에 의존하는 상황일 수 있다.
- Future 집합이 실행하는 모든 태스크의 완료를 기다린다.
- Future 집합에서 가장 빨리 완료되는 태스크를 기다렸다가 결과를 얻는다(예를 들어 여러 태스크가 다양한 방식으로 같은 결과를 구하는 상황).
- 프로그램적으로 Future를 완료시킨다(즉, 비동기 동작에 수동으로 결과 제공).
- Future 완료 동작에 반응한다(즉, 결과를 기다리면서 블록되지 않고 결과가 준비되었다는 알림을 받은 다음에 Future의 결과로 원하는 추가 동작을 수행할 수 있음).

### 16.1.2 CompletableFuture로 비동기 애플리케이션 만들기

CompletableFuture 클래스 (Future 인터페이스를 구현한 클래스)

- 지금까지 설명한 기능을 선언형으로 이용할 수 있도록 자바 8에서 새로 제공
- 람다 표현식과 파이프라이닝을 활용
    - Future ~ CompletableFuture === Collection ~ Stream

## 16.2 비동기 API 구현

> 어떤 제품이나 서비스를 이용해야 하는 상황이라고 가정하자. 예산을 줄일 수 있도록 여러 온라인상점 중 가장 저렴한 가격을 제시하는 상점을 찾는 애플리케이션을 완성해가는 예제

1. 고객에게 비동기 API를 제공하는 방법을 배운다
    1. 온라인상점을 운영하고 있는 독자에게 특히 유용한 기술
2. 동기 API를 사용해야 할 때 코드를 비블록으로 만드는 방법을 배운다.
    1. 두 개의 비동기 동작을 파이프라인으로 만드는 방법과 두 개의 동작 결과를 하나의 비동기 계산으로 합치는 방법을 살펴본다.
    2. 예를 들어 온라인상점에서 우리가 사려는 물건에 대응하는 할인 코드를 반환한다고 가정하자. 우리는 다른 원격 할인 서비스에 접근해서 할인 코드에 해당하는 할인율을 찾아야
       한다. 그래야 원래 가격에 할인율을 적용해서 최종 결과를 계산할 수 있다.
3. 비동기 동작의 완료에 대응하는 방법을 배운다.
    1. 모든 상점에서 가격 정보를 얻을 때까지 기다리는 것이 아니라 각 상점에서 가격 정보를 얻을 때마다 즉시 최저가격을찾는 애플리케이션을 갱신하는 방법을 설명한다
    2. 그렇지 않으면 서버가 다운되는 등 문제가 발생했을 때 사용자에게 검은 화면만 보여주게 될 수 있다.

### 동기 API와 비동기 API

> 전통적인 동기 API에서는 메서드를 호출한 다음에 메서드가 계산을 완료할 때까지 기다렸다가 메서드가 반환되면 호출자는 반환된 값으로 계속 다른 동작을 수행한다. 호출자와 피호출자가 각각 다른 스레드에서 실행되는 상황이었더라도 호출자는 피호출자의 동작 완료를 기다렸을 것이다. 이처럼 동기 API를 사용하는상황을 블록 호출(blocking call) 이라고 한다.
>
> 반면 비동기 API에서는 메서드가 즉시 반환되며 끝내지 못한 나머지 작업을 호출자 스레드와 동기적으로 실행될 수 있도록 다른 스레드에 할당한다. 이와 같은 비동기 API를 사용하는 상황을 비블록 호출(non-blocking call)이라고 한다. 다른 스레드에 할당된 나머지 계산 결과는 콜백 메서드를 호출해서 전달하거나 호출자가 '계산 결과가 끝날 때까지 기다림' 메서드를 추가로 호출하면서 전달된다. 주로 I/O 시스템 프로그래밍에서 이와 같은 방식으로 동작을 수행한다. 즉, 계산 동작을 수행하는 동안 비동기적으로 디스크 접근을 수행한다. 그리고 더 이상 수행할 동작이 없으면 디스크 블록이 메모리로 로딩될 때까지 기다린다.

### 16.2.1 동기 메서드를 비동기 메서드로 변환

`java.util.concurrent.Future` 인터페이스(자바 5)
- 비동기 계산의 결과를 표현할수 있음
- 호출자 스레드가 블록되지 않고 다른 작업을 실행할 수 있다
- Future는 결과값의 핸들일 뿐
  - 계산이 완료되면 결과를 Future를 통해 결과를 얻을 수 있다.
  - 단 인터페이스 구현체는 즉시 반환되므로 호출자 스레드는 다른 작업을 수행할 수 있다
CompletableFuture 클래스(자바8)
  - 동기 메서드를 비동기 메서드로 변환하는데 도움이 되는 기능을 제공
  - 비동기 계산과 완료 결과를 포함하는 CompletableFuture 인스턴스 생성 가능
  - **계산이 끝나기 전에 Future 인스턴스를 바로 반환**
  - complete 메서드를 이용해서 CompletableFuture를 종료할 수 있다

### 16.2.2 에러 처리 방법

가격을 계산하는 동안 에러가 발생하면 어떻게 될까? 
- 예외가 발생하면 해당 스레드에만 영향을 미친다.
- 에러가 발생해도 가격 계산은 계속 진행되며 일의 순서가 꼬인다.
- 결과적으로 클라이언트는 get 메서드가 반환될 때까지 영원히 기다리게 될 수도 있다.

// 타임아웃값을 받는 get 메서드의 오버로드 버전을 만들어 문제를 해결
메인 쓰레드에 exception을 제공

## 16.3 비블록 코드 만들기

### 16.3.1 병렬 스트림으로 요청 병렬화하기

?? .get()은 값이 올때까지 block을 함.
?? .join()도 값이 올때까지 block을 하는가?

1. 은 무조건 다 순차적으로 기다림 
2. 도 기다릴수는 있지만, 1처럼 아예 줄줄이 기다리지는 않음. 병렬수행하면서 결과얻을 떄만 기다림

### 16.3.2 CompletableFuture로 비동기 호출 구현하기

### 16.3.3 더 확장성이 좋은 해결 방법

### 16.3.4 커스텀 Executor 사용하기

?? 공식

## 16.4 비동기 작업 파이프라인 만들기

클라이언트가 블록되는 상황을 거의 완벽하게 회피하는 방법
- 블록하지 않고 Future의 작업이 끝났을 때만 이를 통지받으면서 람다 표현식이나 메서드 참조로 정의된 콜백 메서드를 실행

### 16.4.1 할인서비스구현

### 16.4.2 할인 서비스 사용

### 16.4.3 동기 작업과 비동기 작업 조합하기

### 16.4.4 독립 CompletableFuture와 비독립 CompletableFuture 합치기

### 16.4.5 Future의 리플렉션과 CompletableFuture의 리플렉션

### 16.4.6 타임아웃 효과적으로 사용하기

## 16.5 CompletableFuture의 종료에 대응하는 방법

### 16.5.1 최저가격 검색 애플리케이션 리팩터링

### 16.5.2 응용

## 16.6 로드맵

## 16.7 마치며

- 한 개 이상의 원격 외부 서비스를 시용하는 긴 동작을 실행할 때는 비동기 방식으로 애플리케이션의 성능과 반응성을 향상시킬 수 있다.
- 우리 고객에게 비동기 API를 제공하는 것을 고려해야 한다. CompletableFuture의 기능을 이용하면 쉽게 비동기 API를 구현할 수 있다.
- CompletableFuture를 이용할 때 비동기 태스크에서 발생한 에러를 관리하고 전달할 수 있다.
- 동기 API를 CompletableFuture로 감싸서 비동기적으로 소비할 수 있다.
- 서로 독립적인 비동기 동작이든 아니면 하나의 비동기 동작이 다른 비동기 동작의 결과에 의존하는 상황이든 여러 비동기 동작을 조립하고 조합할 수 있다.
- CompletableFuture에 콜백을 등록해서 Future가 동작을 끝내고 결과를 생산했을 때 어떤 코드를 실행하도록 지정할 수 있다.
- CompletableFuture 리스트의 모든 값이 완료될 때까지 기다릴지 아니면 첫 값만 완료되길 기다릴지 선택할 수 있다.
- 자바 9에서는 orTimeout, completeOnTimeout 메서드로 CompletableFuture에 비동기 타임아웃 기능을 추가했다.